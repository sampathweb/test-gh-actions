# This is a basic workflow that is manually triggered

name: Manual workflow

on:
  push:
    branches:
      - main

jobs:
  get-pr:
    runs-on: ubuntu-latest
    if: "contains(github.event.head_commit.message, '[ROLLBACK_PR=')"
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2
      - name: Get PR and assignee information
        run: |
          echo '::set-output name=assignees::sampathweb'
          cat <<< "${{ github.event.head_commit.message }}" > message.txt
          echo '::set-output name=PR_NUMBER::$(cat message.txt | tr "\n" " " | sed -rn "s/.*ROLLBACK_PR=([^]]+).*/\1/p")'
        id: pr-data
      - name: Echo PR Data Outputs
        run: |
          echo PR ${{ steps.pr-data.outputs.PR_NUMBER }}
          echo Assignee ${{ steps.pr-data.outputs.assignees }}
      - name: Create a new Github Issue
        uses: actions/github-script@v5
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            console.log("Commit Message")
            console.log(context)
            const rollback_commit = context.payload.head_commit.id
            const pr_number = context.payload.head_commit.message.match(/\[ROLLBACK_PR=(\d+).*/)[1]
            console.log(`Hello ${pr_number} ${rollback_commit}`)
            const result = await github.rest.pulls.get({
              owner: "sampathweb",
              repo: context.payload.repository.name,
              pull_number: parseInt(pr_number)
            })
            console.log(result)
